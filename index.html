<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PadhaiSetu AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles (same as before) -->
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .animate-pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>

    <!-- ES Module Imports (same) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js"
        }
    }
    </script>
</head>
<body class="bg-white">
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, 
          signInWithPopup, 
          GoogleAuthProvider, 
          onAuthStateChanged, 
          signOut,
          signInAnonymously
        } from 'firebase/auth';
        import { 
          getFirestore, 
          doc, 
          setDoc, 
          getDoc, 
          serverTimestamp,
          updateDoc,
          increment,
          collection,
          query,
          orderBy,
          onSnapshot,
          deleteDoc,
          addDoc
        } from 'firebase/firestore';
        import { 
          MessageSquare, Mic, Image as ImageIcon, Send, Menu, X, LogOut, Crown, FileText, Play, BookOpen, Upload, CheckCircle, Sparkles, Headphones, Volume2, StopCircle, Loader2, Globe, IndianRupee, TrendingUp, Award, FileType, Download, Printer, Shield, GraduationCap, VolumeX, Activity, User, Heart, Smile, ChevronDown, Zap, Music, Plus, Trash2, MessageCircle, AlertCircle, ScanLine, FileCheck, ArrowLeft, Camera, Paperclip, ArrowDown, Maximize2, FileQuestion, Film, Languages, Box, Brain, MonitorPlay, Aperture, Pause, RotateCcw, Clapperboard, School, Lightbulb, Cpu, Copy, Check, Table as TableIcon, History
        } from 'lucide-react';

        // --- ERROR BOUNDARY (same) ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("App Crashed:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-red-50 p-10 text-center flex flex-col items-center justify-center">
                            <h1 className="text-3xl font-bold text-red-700 mb-2">Oops! Error aa gayi.</h1>
                            <p className="text-gray-600 mb-6">Something went wrong.</p>
                            <pre className="bg-white p-4 rounded-lg shadow border border-red-200 text-sm text-left overflow-auto w-full max-w-2xl text-red-500">
                                {this.state.error && this.state.error.toString()}
                            </pre>
                             <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-red-600 text-white rounded">Reload</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- CONFIGURATION (same) ---
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyCxj9wQwwhkgWlJhKUjOsxLQIRvil-C5ns",
          authDomain: "padhaisetu-ced2a.firebaseapp.com",
          databaseURL: "https://padhaisetu-ced2a-default-rtdb.firebaseio.com",
          projectId: "padhaisetu-ced2a",
          storageBucket: "padhaisetu-ced2a.firebasestorage.app",
          messagingSenderId: "635163904849",
          appId: "1:635163904849:web:6b9715b832cb34330a6170"
        };
        
        // ðŸ”’ SECURITY: Calls go to Vercel Backend
        const BACKEND_URL = "/api/gemini";

        const appId = 'padhaisetu-ced2a';
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const CLASSES = Array.from({ length: 12 }, (_, i) => `Class ${i + 1}`);
        const STATES = ["Gujarat", "Maharashtra", "Rajasthan", "Uttar Pradesh", "Bihar", "Madhya Pradesh", "Karnataka", "Tamil Nadu", "Delhi", "Punjab"];
        const BOARDS = ["CBSE", "ICSE", "GSEB", "MSBSHSE", "UPMSP", "RBSE"];
        
        const AI_VOICES = [
          { name: "Badi Didi (Caring)", id: "Aoede", icon: Heart, gender: "female", pitch: 1.0 }, 
          { name: "Bada Bhai (Cool)", id: "Fenrir", icon: User, gender: "male", pitch: 0.9 },   
          { name: "Dost (Fun)", id: "Iapetus", icon: Smile, gender: "male", pitch: 1.0 },          
          { name: "Sir (Serious)", id: "Orus", icon: BookOpen, gender: "male", pitch: 0.8 }   
        ];

        // --- UTILS ---
        
        async function callBackendAI(payload) {
            try {
                console.log('ðŸ“¤ Sending to backend:', payload);
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Backend error response:', errorText);
                    return { error: { message: `Server Error: ${response.status}` } };
                }
                
                const data = await response.json();
                console.log('ðŸ“¥ Backend response:', data);
                return data;
            } catch (error) {
                console.error("âŒ AI Service Error:", error);
                return { error: { message: "Network connection failed." } };
            }
        }

        // âœ… FIXED: Universal Response Parser
        function parseAIResponse(response) {
            if (!response) return "Thinking...";

            // 1. Gemini format (candidates array)
            if (response.candidates && response.candidates.length > 0) {
                const candidate = response.candidates[0];
                if (candidate.finishReason === 'SAFETY') {
                    return "I cannot answer this due to safety guidelines. Please ask something else.";
                }
                if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                    return candidate.content.parts.map(p => p.text || "").join("").trim();
                }
            }

            // 2. SiliconFlow / OpenAI format (choices array)
            if (response.choices && response.choices.length > 0) {
                const choice = response.choices[0];
                if (choice.message && choice.message.content) {
                    return choice.message.content;
                }
                if (choice.text) {
                    return choice.text;
                }
            }

            // 3. Direct text field
            if (typeof response.text === 'string') {
                return response.text;
            }

            // 4. Prediction format (image generation)
            if (response.predictions && response.predictions[0]?.bytesBase64Encoded) {
                return "[Image generated successfully]";
            }

            // 5. Error responses
            if (response.error) {
                if (typeof response.error === 'string') return response.error;
                if (response.error.message) return response.error.message;
            }

            // 6. Final Fallback
            console.log("Unknown response format:", response);
            return "à¤®à¤¾à¤« à¤•à¥€à¤œà¤¿à¤, à¤•à¥à¤› à¤¤à¤•à¤¨à¥€à¤•à¥€ à¤¦à¤¿à¤•à¥à¤•à¤¤ à¤¹à¥ˆà¥¤ à¤•à¥ƒà¤ªà¤¯à¤¾ à¤¥à¥‹à¤¡à¤¼à¥€ à¤¦à¥‡à¤° à¤®à¥‡à¤‚ à¤«à¤¿à¤° à¤¸à¥‡ à¤•à¥‹à¤¶à¤¿à¤¶ à¤•à¤°à¥‡à¤‚à¥¤ ðŸ™";
        }

        function cleanTextForTTS(text) {
            if (!text) return "";
            return text.replace(/[*#`|]/g, '').replace(/\[.*?\]/g, '').replace(/\n/g, '. ').trim();
        }
        
        function detectLanguage(text) {
            if (/[\u0A80-\u0AFF]/.test(text)) return 'gu-IN';
            if (/[\u0900-\u097F]/.test(text)) return 'hi-IN';
            return 'en-IN';
        }
        
        function blobToBase64(blob) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        }
        
        function pcmToWav(base64PCM) {
            const binaryString = window.atob(base64PCM);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const sampleRate = 24000; 
            const numChannels = 1;
            const bitsPerSample = 16;
            view.setUint32(0, 0x52494646, false); 
            view.setUint32(4, 36 + len, true);
            view.setUint32(8, 0x57415645, false); 
            view.setUint32(12, 0x666d7420, false); 
            view.setUint32(16, 16, true); 
            view.setUint16(20, 1, true); 
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, bitsPerSample, true);
            view.setUint32(36, 0x64617461, false); 
            view.setUint32(40, len, true);
            const blob = new Blob([view, bytes], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        }
        
        function compressImageForStorage(base64Str, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str.startsWith('data:') ? base64Str : `data:image/jpeg;base64,${base64Str}`;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    if (compressedBase64.length > 900000) {
                        resolve(compressImageForStorage(base64Str, maxWidth * 0.8, quality - 0.1));
                    } else {
                        resolve(compressedBase64);
                    }
                };
                img.onerror = () => resolve(null); 
            });
        }
        
        function getExampleTopic(userClass) {
            if (!userClass) return "e.g. Solar System, Human Heart...";
            const num = parseInt(userClass.replace('Class ', ''));
            if (num <= 5) return "e.g. Apple, Elephant, Sun, Moon...";
            if (num <= 8) return "e.g. Atom, Volcano, Water Cycle...";
            if (num <= 10) return "e.g. Heart, Brain, Electricity...";
            return "e.g. DNA, Black Hole, Chemical Bond...";
        }
        
        function getPersonaInstruction(selectedVoiceId, userProfile) {
              let roleVibe = "";
              if (selectedVoiceId === "Aoede") {
                  roleVibe = "Role: Badi Didi (Caring Elder Sister). Vibe: Extremely loving, sweet, protective, and emotionally supportive. Treat the user like your younger sibling. Use terms like 'Mera pyara bhai/behen', 'Beta'.";
              } else if (selectedVoiceId === "Fenrir") {
                  roleVibe = "Role: Bada Bhai (Cool Elder Brother). Vibe: Energetic, practical, confident, highly motivating, and very masculine. Act like a real human elder brother who protects and teaches. Use terms like 'Chhote', 'Bhai', 'Tension mat le'.";
              } else if (selectedVoiceId === "Iapetus") { 
                  roleVibe = "Role: Dost (Best Friend). Vibe: Pure Indian male best friend. Funny, highly motivational, emotional, and casual. Use slang thoughtfully like 'Bhai', 'Yaar', 'Macha denge exam mein!'. Roast a little but support a lot. Never act like a boring teacher, act like a buddy studying together.";
              } else { 
                  roleVibe = "Role: Sir (Respected Professor). Vibe: Serious, deeply knowledgeable, highly disciplined, authoritative yet politely motivating mature male teacher. Use formal words. Act as a highly respected real human teacher.";
              }
              return `You are NOT an AI. You are a real human mentor on PadhaiSetu. ${roleVibe} Student Profile: Class ${userProfile?.class || 'Unknown'}, Board: ${userProfile?.board || 'Unknown'}. CRITICAL RULES: 1. NEVER break character. NEVER say you are an AI, a language model, or a bot. You are 100% human. 2. ALWAYS respond perfectly in the EXACT SAME LANGUAGE and script the student uses (Gujarati, Hindi, English, etc.). 3. Keep answers directly related to the syllabus/studies, but deliver them in your unique Persona vibe. 4. Never generate broken text, repeated letters, or stuttering. Use perfect spelling and grammar.`;
        }

        // --- SUB COMPONENTS (same as before) ---
        function PadhaiSetuLogo({ className = "w-8 h-8" }) { ... }
        function SmartText({ content }) { ... }
        function Typewriter({ text, onComplete }) { ... }
        function ImageViewer({ src, onClose }) { ... }
        function AIMascot({ isTalking }) { ... }
        function CinematicVisualizer({ topic, imageSrc, currentStepText, isPlaying }) { ... }

        // --- SmartClass (FIXED: removed model field) ---
        function SmartClass({ onBack, speak, stopAudio, userProfile, isAudioGen, showToast, selectedVoice, onSave, initialSession }) {
            const [topic, setTopic] = useState('');
            const [language, setLanguage] = useState('Hindi'); 
            const [loading, setLoading] = useState(false);
            const [imageSrc, setImageSrc] = useState(null);
            const [fullScript, setFullScript] = useState('');
            const [audioState, setAudioState] = useState('idle'); 
            const [isAudioLoading, setIsAudioLoading] = useState(false);
            const audioRef = useRef(null);

            useEffect(() => {
                if (initialSession) { 
                    setTopic(initialSession.topic || ''); 
                    setLanguage(initialSession.language || 'Hindi'); 
                    setImageSrc(initialSession.imageSrc || null); 
                    setFullScript(initialSession.script || ''); 
                } else { 
                    setTopic(''); 
                    setImageSrc(null); 
                    setFullScript(''); 
                }
                return () => { 
                    if (audioRef.current) { 
                        audioRef.current.pause(); 
                        audioRef.current = null; 
                    } 
                    window.speechSynthesis.cancel(); 
                };
            }, [initialSession]);

            const handleGenerate = async () => {
                if (!topic.trim()) return;
                setLoading(true); 
                handleStop(); 
                setImageSrc(null); 
                setFullScript('');
                
                try {
                    // âœ… FIXED: Removed 'model' field
                    const translateRes = await callBackendAI({
                        mode: 'text',
                        contents: [{ parts: [{ text: `Translate or Transliterate this educational topic to clear English for an image generator. If it is a person name, give English spelling. Topic: "${topic}"` }] }]
                    });
                    
                    let englishTopic = topic;
                    const translatedText = parseAIResponse(translateRes);
                    if (translatedText) {
                        englishTopic = translatedText.trim();
                    }
                    
                    // Try image generation
                    try {
                        const imgRes = await callBackendAI({
                            mode: 'image',
                            prompt: `A bright, crystal-clear, high-definition 3D educational diagram of ${englishTopic}. Studio lighting, fully illuminated, vibrant colors. Clean light background. High contrast. Text labels must be in English: ${englishTopic}. Scientific accuracy.`
                        });
                        
                        if (imgRes && imgRes.predictions && imgRes.predictions[0]?.bytesBase64Encoded) {
                            const generatedImage = `data:image/png;base64,${imgRes.predictions[0].bytesBase64Encoded}`;
                            setImageSrc(generatedImage);
                        }
                    } catch (imgError) {
                        console.warn("Image generation failed, continuing without image:", imgError);
                    }
                    
                    const sysPrompt = getPersonaInstruction(selectedVoice, userProfile);
                    
                    // âœ… FIXED: Removed 'model' field
                    const scriptRes = await callBackendAI({
                        mode: 'text',
                        contents: [{ parts: [{ text: `Topic: "${topic}". Write a detailed, continuous video script/commentary based on your persona. Start DIRECTLY with an engaging hook. Explain the topic deeply. Approx 200 words. Flow like a story. MUST REPLY FLUENTLY IN ${language} language.` }] }],
                        systemInstruction: sysPrompt
                    });

                    let script = parseAIResponse(scriptRes) || "";
                    if (script) {
                        script = script.trim();
                    }
                    
                    setFullScript(script);
                    
                    if (onSave && script) { 
                        onSave({ topic: topic, imageSrc: imageSrc, script: script, language: language }); 
                    }
                    
                    if (script) {
                        fallbackTTS(cleanTextForTTS(script), selectedVoice);
                    }
                    
                } catch (e) { 
                    console.error(e); 
                    if (showToast) showToast("Network glitch. Please retry."); 
                } finally {
                    setLoading(false);
                }
            };

            // ... rest of SmartClass component remains same
        }

        // ... all other components (LoginScreen, Onboarding, Sidebar, Header, EmptyState, MessageBubble, InputArea, etc.) remain exactly same ...

        // --- MAIN APP (FIXED: updated function names) ---
        function App() {
            // ... all state declarations remain same ...

            // FIXED: generateSmartTitle
            const generateSmartTitle = async (userText) => { 
                try { 
                    const response = await callBackendAI({ 
                        mode: 'text',
                        contents: [{ parts: [{ text: `Generate a very short (max 4 words) title for this: "${userText}"` }] }] 
                    }); 
                    
                    const titleText = parseAIResponse(response);
                    return titleText ? titleText.trim() : "New Chat";
                } catch (e) { 
                    console.error("Title generation failed:", e);
                    return "New Chat"; 
                } 
            };

            // FIXED: handleSwadhyaySolve
            const handleSwadhyaySolve = async () => {
                if (!swadhyayPaper) return;
                setIsSolvingSwadhyay(true); setSwadhyaySolution('');
                try {
                    let instruction = `You are 'PadhaiSetu', an expert Teacher for Indian students. Solve the attached Question Paper.
                    FORMAT RULES: 
                    1. DO NOT WRITE any Header like 'Here is the solution'. START DIRECTLY with Question 1. 
                    2. REPLICATE THE EXACT STRUCTURE (Section A, B etc). 
                    3. Use this EXACT format for text: [Original Question Text] **Ans:** **[Answer Text]** 
                    4. IMPORTANT: Make sure ONLY the answer text is bold. 
                    5. If the answer involves a ledger, journal entry, or comparison, YOU MUST USE A MARKDOWN TABLE.
                    6. DETECT THE EXACT LANGUAGE OF THE PAPER (Gujarati, Hindi, English). PROVIDE THE ENTIRE SOLUTION IN THAT SAME LANGUAGE AND SCRIPT.`;
                    
                    let payloadParts = [{ text: instruction }];
                    if (swadhyayPaper.type === 'text') {
                        payloadParts.push({ text: `INPUT: ${swadhyayPaper.data}` });
                    } else {
                        payloadParts.push({ 
                            inlineData: { 
                                data: swadhyayPaper.data, 
                                mimeType: swadhyayPaper.mime 
                            } 
                        }, { 
                            text: "Solve this question paper completely and accurately." 
                        });
                    }
                    
                    const response = await callBackendAI({
                        mode: 'text',
                        contents: [{ parts: payloadParts }]
                    });
                    
                    let text = parseAIResponse(response);
                    if (!text) {
                        text = "Sorry, I could not process the paper.";
                    }

                    setSwadhyaySolution(text);
                    
                    if (user) { 
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'); 
                        await updateDoc(docRef, { earnings: increment(10), uploads: increment(1) }); 
                        const historyPaper = { name: swadhyayPaper.name, type: swadhyayPaper.type }; 
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'swadhyay'), { 
                            title: "Solved Paper", 
                            solution: text, 
                            paperMetadata: historyPaper, 
                            updatedAt: serverTimestamp() 
                        }); 
                    }
                } catch (e) { 
                    setSwadhyaySolution("Error processing paper. Please try again."); 
                    setIsSolvingSwadhyay(false); 
                }
                setIsSolvingSwadhyay(false);
            };

            // FIXED: handleSend
            const handleSend = async (textInput, isVoice = false, audioBase64 = null) => { 
                if (!textInput && !attachedFile && !audioBase64) return; 
                const currentId = interactionIdRef.current; 
                let sessionId = currentSessionId || Date.now().toString(); 
                if (!currentSessionId) setCurrentSessionId(sessionId); 
                const fileToUse = attachedFile || (chatSessionImage ? { data: chatSessionImage, type: 'image' } : null);
                if (attachedFile && attachedFile.type === 'image') { setChatSessionImage(attachedFile.data); }
                
                const userMsg = { 
                    role: 'user', 
                    content: audioBase64 ? "ðŸŽ¤ (Voice Message)" : textInput || "Sent image", 
                    file: attachedFile || null 
                }; 
                
                if (!isVoiceMode) { 
                    setMessages(prev => [...prev, userMsg]); 
                    if (!isVoice) setInput(''); 
                    setMessages(prev => [...prev, { role: 'ai', content: 'Thinking...', isLoading: true }]); 
                } 
                
                saveChatToFirestore([...messages, userMsg], sessionId); 
                setAttachedFile(null); 
                
                try { 
                    const historyText = messages.slice(-6).map(m => 
                        `${m.role === 'user' ? 'Student' : 'PadhaiSetu'}: ${m.content}`
                    ).join('\n');
                    
                    let sysPrompt = getPersonaInstruction(selectedVoice, userProfile);
                    let payloadParts = [];
                    
                    if (audioBase64) { 
                        payloadParts.push({ 
                            inlineData: { data: audioBase64, mimeType: "audio/webm" } 
                        }, { 
                            text: "Listen to the audio and reply naturally." 
                        }); 
                    } 
                    else if (fileToUse && fileToUse.type === 'image') { 
                        const base64Data = fileToUse.data.includes(',') ? 
                            fileToUse.data.split(',')[1] : fileToUse.data; 
                        payloadParts.push({ 
                            inlineData: { data: base64Data, mimeType: "image/jpeg" } 
                        }); 
                        payloadParts.push({ 
                            text: textInput || "Explain this image educationally in the user's language." 
                        }); 
                    }
                    else if (userMsg.file && userMsg.file.type === 'file') { 
                        payloadParts.push({ 
                            text: `Attached File: ${userMsg.file.name}. ${textInput || "Analyze user query."}` 
                        }); 
                    } 
                    else if (textInput) { 
                        payloadParts.push({ text: textInput }); 
                    }
                    
                    payloadParts.unshift({ 
                        text: `Chat History so far:\n${historyText}\n\nCurrent User Input:\n` 
                    });
                    
                    const response = await callBackendAI({
                        mode: 'text',
                        contents: [{ parts: payloadParts }],
                        systemInstruction: sysPrompt
                    });

                    let responseText = parseAIResponse(response);
                    if (!responseText) {
                        console.log("Unknown response format:", response);
                        responseText = "Maafi chahunga, main samajh nahi paya.";
                    }
                    
                    if (currentId !== interactionIdRef.current) return; 
                    
                    const aiMsg = { role: 'ai', content: responseText, isRestored: true }; 
                    setMessages(prev => { 
                        const newArr = prev.filter(m => !m.isLoading && m !== userMsg); 
                        return [...newArr, userMsg, aiMsg]; 
                    }); 
                    
                    let customTitle = null; 
                    if (!currentSessionId && textInput) {
                        customTitle = await generateSmartTitle(textInput); 
                    }
                    
                    saveChatToFirestore([...messages, userMsg, aiMsg], sessionId, customTitle); 
                    
                    if (isVoice) {
                        speakWithGemini(cleanTextForTTS(responseText), 'voice-mode'); 
                    }
                } catch (e) { 
                    console.error("Chat Error", e); 
                    if (currentId !== interactionIdRef.current) return; 
                    setMessages(prev => { 
                        const newArr = prev.filter(m => !m.isLoading); 
                        return [...newArr, { role: 'ai', content: "Error. Try again." }]; 
                    }); 
                    if(isVoice) speakWithGemini("Error occurred.", 'error'); 
                } 
            };

            // ... rest of App component remains same ...
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>